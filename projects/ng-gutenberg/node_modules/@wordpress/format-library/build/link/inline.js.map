{"version":3,"sources":["@wordpress/format-library/src/link/inline.js"],"names":["stopKeyPropagation","event","stopPropagation","isShowingInput","props","state","addingLink","editLink","URLPopoverAtLink","isActive","value","anchorRect","selection","window","getSelection","range","rangeCount","getRangeAt","element","startContainer","nextElementSibling","nodeType","Node","ELEMENT_NODE","parentNode","closest","getBoundingClientRect","start","end","InlineLinkUI","arguments","bind","submitLink","onKeyDown","onChangeInputValue","setLinkTarget","onFocusOutside","resetState","autocompleteRef","opensInNewWindow","inputValue","LEFT","DOWN","RIGHT","UP","BACKSPACE","ENTER","indexOf","keyCode","setState","activeAttributes","url","onChange","selectedText","text","preventDefault","speak","format","toInsert","length","autocompleteElement","current","contains","document","activeElement","stopAddingLink","showInput","undefined","target","update","Object","keys","Component"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\nimport { Component, createRef, useMemo } from '@wordpress/element';\nimport {\n\tToggleControl,\n\twithSpokenMessages,\n} from '@wordpress/components';\nimport { LEFT, RIGHT, UP, DOWN, BACKSPACE, ENTER } from '@wordpress/keycodes';\nimport { getRectangleFromRange } from '@wordpress/dom';\nimport { prependHTTP } from '@wordpress/url';\nimport {\n\tcreate,\n\tinsert,\n\tisCollapsed,\n\tapplyFormat,\n\tgetTextContent,\n\tslice,\n} from '@wordpress/rich-text';\nimport { URLPopover } from '@wordpress/block-editor';\n\n/**\n * Internal dependencies\n */\nimport { createLinkFormat, isValidHref } from './utils';\n\nconst stopKeyPropagation = ( event ) => event.stopPropagation();\n\nfunction isShowingInput( props, state ) {\n\treturn props.addingLink || state.editLink;\n}\n\nconst URLPopoverAtLink = ( { isActive, addingLink, value, ...props } ) => {\n\tconst anchorRect = useMemo( () => {\n\t\tconst selection = window.getSelection();\n\t\tconst range = selection.rangeCount > 0 ? selection.getRangeAt( 0 ) : null;\n\t\tif ( ! range ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( addingLink ) {\n\t\t\treturn getRectangleFromRange( range );\n\t\t}\n\n\t\tlet element = range.startContainer;\n\n\t\t// If the caret is right before the element, select the next element.\n\t\telement = element.nextElementSibling || element;\n\n\t\twhile ( element.nodeType !== window.Node.ELEMENT_NODE ) {\n\t\t\telement = element.parentNode;\n\t\t}\n\n\t\tconst closest = element.closest( 'a' );\n\t\tif ( closest ) {\n\t\t\treturn closest.getBoundingClientRect();\n\t\t}\n\t}, [ isActive, addingLink, value.start, value.end ] );\n\n\tif ( ! anchorRect ) {\n\t\treturn null;\n\t}\n\n\treturn <URLPopover anchorRect={ anchorRect } { ...props } />;\n};\n\nclass InlineLinkUI extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.editLink = this.editLink.bind( this );\n\t\tthis.submitLink = this.submitLink.bind( this );\n\t\tthis.onKeyDown = this.onKeyDown.bind( this );\n\t\tthis.onChangeInputValue = this.onChangeInputValue.bind( this );\n\t\tthis.setLinkTarget = this.setLinkTarget.bind( this );\n\t\tthis.onFocusOutside = this.onFocusOutside.bind( this );\n\t\tthis.resetState = this.resetState.bind( this );\n\t\tthis.autocompleteRef = createRef();\n\n\t\tthis.state = {\n\t\t\topensInNewWindow: false,\n\t\t\tinputValue: '',\n\t\t};\n\t}\n\n\tstatic getDerivedStateFromProps( props, state ) {\n\t\tconst { activeAttributes: { url, target } } = props;\n\t\tconst opensInNewWindow = target === '_blank';\n\n\t\tif ( ! isShowingInput( props, state ) ) {\n\t\t\tconst update = {};\n\t\t\tif ( url !== state.inputValue ) {\n\t\t\t\tupdate.inputValue = url;\n\t\t\t}\n\n\t\t\tif ( opensInNewWindow !== state.opensInNewWindow ) {\n\t\t\t\tupdate.opensInNewWindow = opensInNewWindow;\n\t\t\t}\n\t\t\treturn Object.keys( update ).length ? update : null;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tonKeyDown( event ) {\n\t\tif ( [ LEFT, DOWN, RIGHT, UP, BACKSPACE, ENTER ].indexOf( event.keyCode ) > -1 ) {\n\t\t\t// Stop the key event from propagating up to ObserveTyping.startTypingInTextField.\n\t\t\tevent.stopPropagation();\n\t\t}\n\t}\n\n\tonChangeInputValue( inputValue ) {\n\t\tthis.setState( { inputValue } );\n\t}\n\n\tsetLinkTarget( opensInNewWindow ) {\n\t\tconst { activeAttributes: { url = '' }, value, onChange } = this.props;\n\n\t\tthis.setState( { opensInNewWindow } );\n\n\t\t// Apply now if URL is not being edited.\n\t\tif ( ! isShowingInput( this.props, this.state ) ) {\n\t\t\tconst selectedText = getTextContent( slice( value ) );\n\n\t\t\tonChange( applyFormat( value, createLinkFormat( {\n\t\t\t\turl,\n\t\t\t\topensInNewWindow,\n\t\t\t\ttext: selectedText,\n\t\t\t} ) ) );\n\t\t}\n\t}\n\n\teditLink( event ) {\n\t\tthis.setState( { editLink: true } );\n\t\tevent.preventDefault();\n\t}\n\n\tsubmitLink( event ) {\n\t\tconst { isActive, value, onChange, speak } = this.props;\n\t\tconst { inputValue, opensInNewWindow } = this.state;\n\t\tconst url = prependHTTP( inputValue );\n\t\tconst selectedText = getTextContent( slice( value ) );\n\t\tconst format = createLinkFormat( {\n\t\t\turl,\n\t\t\topensInNewWindow,\n\t\t\ttext: selectedText,\n\t\t} );\n\n\t\tevent.preventDefault();\n\n\t\tif ( isCollapsed( value ) && ! isActive ) {\n\t\t\tconst toInsert = applyFormat( create( { text: url } ), format, 0, url.length );\n\t\t\tonChange( insert( value, toInsert ) );\n\t\t} else {\n\t\t\tonChange( applyFormat( value, format ) );\n\t\t}\n\n\t\tthis.resetState();\n\n\t\tif ( ! isValidHref( url ) ) {\n\t\t\tspeak( __( 'Warning: the link has been inserted but may have errors. Please test it.' ), 'assertive' );\n\t\t} else if ( isActive ) {\n\t\t\tspeak( __( 'Link edited.' ), 'assertive' );\n\t\t} else {\n\t\t\tspeak( __( 'Link inserted.' ), 'assertive' );\n\t\t}\n\t}\n\n\tonFocusOutside() {\n\t\t// The autocomplete suggestions list renders in a separate popover (in a portal),\n\t\t// so onFocusOutside fails to detect that a click on a suggestion occurred in the\n\t\t// LinkContainer. Detect clicks on autocomplete suggestions using a ref here, and\n\t\t// return to avoid the popover being closed.\n\t\tconst autocompleteElement = this.autocompleteRef.current;\n\t\tif ( autocompleteElement && autocompleteElement.contains( document.activeElement ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.resetState();\n\t}\n\n\tresetState() {\n\t\tthis.props.stopAddingLink();\n\t\tthis.setState( { editLink: false } );\n\t}\n\n\trender() {\n\t\tconst { isActive, activeAttributes: { url }, addingLink, value } = this.props;\n\n\t\tif ( ! isActive && ! addingLink ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst { inputValue, opensInNewWindow } = this.state;\n\t\tconst showInput = isShowingInput( this.props, this.state );\n\n\t\treturn (\n\t\t\t<URLPopoverAtLink\n\t\t\t\tvalue={ value }\n\t\t\t\tisActive={ isActive }\n\t\t\t\taddingLink={ addingLink }\n\t\t\t\tonFocusOutside={ this.onFocusOutside }\n\t\t\t\tonClose={ this.resetState }\n\t\t\t\tfocusOnMount={ showInput ? 'firstElement' : false }\n\t\t\t\trenderSettings={ () => (\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel={ __( 'Open in New Tab' ) }\n\t\t\t\t\t\tchecked={ opensInNewWindow }\n\t\t\t\t\t\tonChange={ this.setLinkTarget }\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t>\n\t\t\t\t{ showInput ? (\n\t\t\t\t\t<URLPopover.LinkEditor\n\t\t\t\t\t\tclassName=\"editor-format-toolbar__link-container-content block-editor-format-toolbar__link-container-content\"\n\t\t\t\t\t\tvalue={ inputValue }\n\t\t\t\t\t\tonChangeInputValue={ this.onChangeInputValue }\n\t\t\t\t\t\tonKeyDown={ this.onKeyDown }\n\t\t\t\t\t\tonKeyPress={ stopKeyPropagation }\n\t\t\t\t\t\tonSubmit={ this.submitLink }\n\t\t\t\t\t\tautocompleteRef={ this.autocompleteRef }\n\t\t\t\t\t/>\n\t\t\t\t) : (\n\t\t\t\t\t<URLPopover.LinkViewer\n\t\t\t\t\t\tclassName=\"editor-format-toolbar__link-container-content block-editor-format-toolbar__link-container-content\"\n\t\t\t\t\t\tonKeyPress={ stopKeyPropagation }\n\t\t\t\t\t\turl={ url }\n\t\t\t\t\t\tonEditLinkClick={ this.editLink }\n\t\t\t\t\t\tlinkClassName={ isValidHref( prependHTTP( url ) ) ? undefined : 'has-invalid-link' }\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t</URLPopoverAtLink>\n\t\t);\n\t}\n}\n\nexport default withSpokenMessages( InlineLinkUI );\n"]}